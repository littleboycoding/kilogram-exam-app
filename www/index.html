<!DOCTYPE html>
<html>
  <head>
    <title>Kilogram Exam</title>
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <meta name="mobile-web-app-capable" content="yes" />
    <script type="text/javascript" src="adapter-latest.js"></script>
    <script type="text/javascript" src="tracking-min.js"></script>
    <script
      type="text/javascript"
      src="tracking-js-kilogram-script.js"
    ></script>
    <style>
      * {
        box-sizing: border-box;
      }
      .rect {
        position: absolute;
      }
      body {
        background-color: #eee;
        margin: 0;
      }
      html,
      body {
        height: 100%;
        width: 100%;
      }
      video,
      canvas,
      span {
        position: absolute;
      }
      canvas,
      video {
        animation: 0.3s fade;
        opacity: 1;
      }
      @keyframes fade {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div onclick="snapshot();">
        <video style="display: none;" id="player" autoplay=""></video>
        <canvas id="canvas"></canvas>
      </div>
    </div>
    <script type="text/javascript" src="js/document_transform.js"></script>
    <script
      async
      onload="onOpenCvReady();"
      type="text/javascript"
      src="js/opencv.js"
    ></script>
    <script type="text/javascript">
      const player = document.querySelector("#player");
      const canvas = document.querySelector("#canvas");
      var check;
      var close_timeout;

      window.onresize = () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      };

      function snapshot() {
        if (canvas.style.display === "none") {
          let context = canvas.getContext("2d");

          context.drawImage(player, 0, 0);
          transform();
          tracking_start();

          canvas.style.display = "block";
          player.style.display = "none";
          close_timeout = setTimeout(close_snapshot, 3000);
        } else {
          close_snapshot();
        }
      }

      function close_snapshot() {
        clearTimeout(close_timeout);

        canvas.style.display = "none";
        player.style.display = "block";
      }

      function onOpenCvReady() {
        startCamera();
        check = setInterval(() => {
          if (cv.Mat != undefined) {
            clearInterval(check);
            document.getElementById("player").style.display = "block";
          }
        }, 0.5);
      }
      function startCamera() {
        const constraints = {
          video: {
            facingMode: { ideal: "environment" },
            width: window.innerHeight,
            height: window.innerWidth
          }
        };
        navigator.mediaDevices.getUserMedia(constraints).then(stream => {
          player.srcObject = stream;
          window.onresize();
        });
      }
    </script>
  </body>
</html>
